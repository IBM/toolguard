{
  "created": 1756626070.4932969,
  "duration": 0.1423778533935547,
  "exitcode": 1,
  "root": "/Users/davidboaz/Documents/GitHub/gen_policy_validator",
  "environment": {},
  "summary": {
    "failed": 1,
    "total": 2,
    "collected": 2
  },
  "collectors": [
    {
      "nodeid": "",
      "outcome": "passed",
      "result": [
        {
          "nodeid": "eval/airline/output/2025-08-31_10_38_30/tests/update_reservation_baggages/test_guard_baggage_addition_policy.py",
          "type": "Module",
          "lineno": null
        }
      ],
      "longrepr": null
    },
    {
      "nodeid": "eval/airline/output/2025-08-31_10_38_30/tests/update_reservation_baggages/test_guard_baggage_addition_policy.py",
      "outcome": "passed",
      "result": [
        {
          "nodeid": "eval/airline/output/2025-08-31_10_38_30/tests/update_reservation_baggages/test_guard_baggage_addition_policy.py::test_increase_bags_gold_business",
          "type": "Function",
          "lineno": 8
        },
        {
          "nodeid": "eval/airline/output/2025-08-31_10_38_30/tests/update_reservation_baggages/test_guard_baggage_addition_policy.py::test_cannot_remove_checked_bags",
          "type": "Function",
          "lineno": 48
        }
      ],
      "longrepr": null
    }
  ],
  "tests": [
    {
      "nodeid": "eval/airline/output/2025-08-31_10_38_30/tests/update_reservation_baggages/test_guard_baggage_addition_policy.py::test_increase_bags_gold_business",
      "lineno": 8,
      "outcome": "failed",
      "keywords": [
        "test_increase_bags_gold_business",
        "test_guard_baggage_addition_policy.py",
        "update_reservation_baggages",
        "tests",
        "2025-08-31_10_38_30",
        "output",
        "airline",
        "eval",
        "gen_policy_validator",
        ""
      ],
      "setup": {
        "duration": 0.0008760830387473106,
        "outcome": "passed"
      },
      "call": {
        "duration": 0.0008178330026566982,
        "outcome": "failed",
        "crash": {
          "path": "/Users/davidboaz/Documents/GitHub/gen_policy_validator/eval/airline/output/2025-08-31_10_38_30/airline/update_reservation_baggages/guard_baggage_addition_policy.py",
          "lineno": 43,
          "message": "rt_toolguard.data_types.PolicyViolationException: nonfree_baggages should be 1 based on membership and cabin allowance."
        },
        "traceback": [
          {
            "path": "tests/update_reservation_baggages/test_guard_baggage_addition_policy.py",
            "lineno": 47,
            "message": ""
          },
          {
            "path": "airline/update_reservation_baggages/guard_baggage_addition_policy.py",
            "lineno": 43,
            "message": "PolicyViolationException"
          }
        ],
        "longrepr": "def test_increase_bags_gold_business():\n        \"\"\"\n        Policy: \"When using the update_reservation_baggages tool, you can add checked bags to an existing reservation but cannot remove them...\"\n        Example: \"Increasing checked bags from 2 to 4 on reservation 'ZFA04Y': A gold member in business class adds 2 additional nonfree bags using a stored credit card, correctly applying fees according to policy.\"\n        \"\"\"\n        user = User(\n            user_id=\"user123\",\n            name=Name(first_name=\"John\", last_name=\"Doe\"),\n            address=Address(address1=\"123 St\", address2=None, city=\"City\", country=\"Country\", state=\"State\", zip=\"12345\"),\n            email=\"john@example.com\",\n            dob=\"1980-01-01\",\n            payment_methods={\n                \"credit_card_7815826\": CreditCard(source=\"credit_card\", brand=\"visa\", last_four=\"1234\", id=\"credit_card_7815826\")\n            },\n            saved_passengers=[],\n            membership=\"gold\",\n            reservations=[\"ZFA04Y\"]\n        )\n        reservation = Reservation(\n            reservation_id=\"ZFA04Y\",\n            user_id=\"user123\",\n            origin=\"SFO\",\n            destination=\"JFK\",\n            flight_type=\"round_trip\",\n            cabin=\"business\",\n            flights=[],\n            passengers=[],\n            payment_history=[],\n            created_at=datetime.now().strftime(\"%Y-%m-%dT%H:%M:%S\"),\n            total_baggages=2,\n            nonfree_baggages=0,\n            insurance=\"no\",\n            status=None\n        )\n        api = MagicMock(spec=I_Airline)\n        api.get_user_details.side_effect = lambda uid: user if uid == \"user123\" else None\n        api.get_reservation_details.side_effect = lambda rid: reservation if rid == \"ZFA04Y\" else None\n    \n>       guard_baggage_addition_policy(api, reservation_id=\"ZFA04Y\", total_baggages=4, nonfree_baggages=2, payment_id=\"credit_card_7815826\")\n\ntests/update_reservation_baggages/test_guard_baggage_addition_policy.py:47: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\napi = <MagicMock spec='I_Airline' id='4370096752'>, reservation_id = 'ZFA04Y', total_baggages = 4\nnonfree_baggages = 2, payment_id = 'credit_card_7815826'\n\n    def guard_baggage_addition_policy(api: I_Airline, reservation_id: str, total_baggages: int, nonfree_baggages: int, payment_id: str):\n        \"\"\"\n        Guard to enforce baggage addition policy when updating reservation baggages.\n        \"\"\"\n        # Get current reservation details\n        reservation = api.get_reservation_details(reservation_id)\n        user = api.get_user_details(reservation.user_id)\n    \n        # 1. Cannot remove checked bags\n        if total_baggages < reservation.total_baggages:\n            raise PolicyViolationException(\"Cannot remove checked bags from the reservation.\")\n    \n        # 2. Determine free baggage allowance based on membership and cabin class\n        allowance_table = {\n            'regular': {'basic_economy': 0, 'economy': 1, 'business': 2},\n            'silver': {'basic_economy': 1, 'economy': 2, 'business': 3},\n            'gold': {'basic_economy': 2, 'economy': 3, 'business': 3},\n        }\n        free_allowance = allowance_table[user.membership][reservation.cabin]\n    \n        # 3. Calculate expected nonfree_baggages based on total bags and free allowance\n        # The free allowance applies to the total bags, but we must ensure we don't count bags already in the reservation twice.\n        # Only additional bags beyond the previous total are considered for fee calculation.\n        additional_bags = total_baggages - reservation.total_baggages\n        if additional_bags < 0:\n            additional_bags = 0  # Already handled removal above, but safeguard.\n    \n        # Calculate how many of the total bags are non-free based on allowance\n        expected_nonfree_total = max(total_baggages - free_allowance, 0)\n    \n        # Adjust expected_nonfree_total to account for already paid nonfree bags in the reservation\n        already_paid_nonfree = reservation.nonfree_baggages\n        expected_nonfree_total = max(expected_nonfree_total, already_paid_nonfree)\n    \n        if nonfree_baggages != expected_nonfree_total:\n>           raise PolicyViolationException(\n                f\"nonfree_baggages should be {expected_nonfree_total} based on membership and cabin allowance.\"\n            )\nE           rt_toolguard.data_types.PolicyViolationException: nonfree_baggages should be 1 based on membership and cabin allowance.\n\nairline/update_reservation_baggages/guard_baggage_addition_policy.py:43: PolicyViolationException"
      },
      "user_properties": [
        {
          "docstring": "\n    Policy: \"When using the update_reservation_baggages tool, you can add checked bags to an existing reservation but cannot remove them...\"\n    Example: \"Increasing checked bags from 2 to 4 on reservation 'ZFA04Y': A gold member in business class adds 2 additional nonfree bags using a stored credit card, correctly applying fees according to policy.\"\n    "
        }
      ],
      "teardown": {
        "duration": 0.00017158407717943192,
        "outcome": "passed"
      }
    },
    {
      "nodeid": "eval/airline/output/2025-08-31_10_38_30/tests/update_reservation_baggages/test_guard_baggage_addition_policy.py::test_cannot_remove_checked_bags",
      "lineno": 48,
      "outcome": "passed",
      "keywords": [
        "test_cannot_remove_checked_bags",
        "test_guard_baggage_addition_policy.py",
        "update_reservation_baggages",
        "tests",
        "2025-08-31_10_38_30",
        "output",
        "airline",
        "eval",
        "gen_policy_validator",
        ""
      ],
      "setup": {
        "duration": 0.00011079199612140656,
        "outcome": "passed"
      },
      "call": {
        "duration": 0.0007753749378025532,
        "outcome": "passed",
        "crash": null,
        "traceback": null,
        "longrepr": null
      },
      "user_properties": [
        {
          "docstring": "\n    Policy: \"Change baggage and insurance: The user can add but not remove checked bags.\"\n    Example: \"Updating reservation with ID 'ZFA04Y' to reduce the total checked bags from 3 to 2, violating the policy that prevents removing checked bags.\"\n    "
        }
      ],
      "teardown": {
        "duration": 0.00010637519881129265,
        "outcome": "passed"
      }
    }
  ]
}